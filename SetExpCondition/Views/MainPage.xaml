<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:SetExpCondition.ViewModels"
             xmlns:controls="clr-namespace:SetExpCondition.Controls"
             x:Class="SetExpCondition.Views.MainPage"
             x:Name="PageRoot">

    <ContentPage.BindingContext>
        <viewmodels:MainViewModel />
    </ContentPage.BindingContext>

    <!-- Grid で上部（Auto）と下部（*）に分け、最下部に CSV ボタン用の Auto 行を追加 -->
    <Grid RowDefinitions="Auto,*,Auto">
        <!--
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        -->
        <!-- 上部: スクロール可能な入力領域 -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="30,10" Spacing="25">
                <!-- 省略せず既存の内容を保持 -->
                <!-- Entry と「保存先確定」「未選択」ボタンを並べる -->
                <Grid ColumnDefinitions="7*,2*,1*" ColumnSpacing="10">
                    <Entry Text="{Binding FolderPath}" FontSize="18" Grid.Column="0" />
                    <Button Text="Select"
                            FontSize="18"
                            Clicked="OnConfirmFolderClicked"
                            Grid.Column="1" />
                    <Button Text="Delete"
                            FontSize="16"
                            Clicked="OnClearSelectionClicked"
                            Grid.Column="2" />
                </Grid>

                <!-- 選択された CSV ファイル名（拡張子付き）を表示（白線で囲む） -->
                <Border Stroke="White"
                        StrokeThickness="1"
                        Padding="8"
                        BackgroundColor="Transparent"
                        HorizontalOptions="FillAndExpand">
                    <HorizontalStackLayout HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           Spacing="15">
                        <Label Text="{Binding DisplayText}" 
                               FontSize="16"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center" />
                        <Label Text="{Binding SelectedCsvFileName}"
                               FontSize="16"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center" />
                    </HorizontalStackLayout>
                </Border>
                    
                
                <!-- 空白用 -->
                <Label Text=""
                    HeightRequest="5"
                    HorizontalOptions="Center"/>
              
                
                
                <!-- Pickers をここに置く -->
                <HorizontalStackLayout Spacing="40" HorizontalOptions="Center">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Physical Locomotion method" Style="{StaticResource SubHeadline}" HorizontalOptions="Center" />
                        <Picker Title=""
                                ItemsSource="{Binding Options1}"
                                SelectedItem="{Binding SelectedOption1, Mode=TwoWay}" />
                    </VerticalStackLayout>

                    <VerticalStackLayout Spacing="10">
                        <Label Text="Virtual self-Movement Speed" Style="{StaticResource SubHeadline}" HorizontalOptions="Center" />
                        <Picker Title=""
                                ItemsSource="{Binding Options2}"
                                SelectedItem="{Binding SelectedOption2, Mode=TwoWay}" />
                    </VerticalStackLayout>
                </HorizontalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

        <!-- 下部: FlexLayout で横方向に並べ、幅を超えたら折り返す -->
        <ScrollView Grid.Row="1" Orientation="Vertical" VerticalOptions="FillAndExpand">
            <FlexLayout
                BindableLayout.ItemsSource="{Binding Conditions}"
                Direction="Row"
                Wrap="Wrap"
                JustifyContent="Center"
                AlignItems="Start"
                AlignContent="Start"
                Padding="10">

                <BindableLayout.ItemTemplate>
                    <DataTemplate>
                        <controls:ConditionButton
                            Text="{Binding Name}"
                            Factor1="{Binding Factor1}"
                            Factor2="{Binding Factor2}"
                            IsSelected="{Binding IsSelected}"
                            Command="{Binding Source={x:Reference PageRoot}, Path=BindingContext.SelectConditionCommand}"
                            CommandParameter="{Binding .}"
                            WidthRequest="135"
                            HeightRequest="120"
                            HorizontalOptions="Center"
                            VerticalOptions="Start" />
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </FlexLayout>
        </ScrollView>

        <!-- 最下部: 試行回数コントロールと CSV保存ボタン -->
        <Grid Grid.Row="2" Padding="10">
            <VerticalStackLayout HorizontalOptions="Center" Spacing="10">
                <HorizontalStackLayout Spacing="12" HorizontalOptions="Center">
                    <Label Text="Trial Count:"
                           FontSize="24"
                           VerticalOptions="Center" />
                    <Button Text="－"
                            WidthRequest="40" HeightRequest="40"
                            Command="{Binding DecreaseTrialCountCommand}" />
                    <Label Text="{Binding TrialCount}"
                           FontSize="24"
                           VerticalOptions="Center"
                           HorizontalOptions="Center" />
                    <Button Text="＋"
                            WidthRequest="40" HeightRequest="40"
                            Command="{Binding IncreaseTrialCountCommand}" />
                    <!-- 追加: 右側にリセットボタン（横に配置） -->
                    <Button Text="Reset"
                            WidthRequest="100" HeightRequest="40"
                            Command="{Binding ResetTrialCountCommand}" />
                </HorizontalStackLayout>

                <Button Text="Save CSV"
                        FontSize="24"
                        HorizontalOptions="Center"
                        VerticalOptions="Center"
                        HeightRequest="80"
                        WidthRequest="400"
                        Margin="15"
                        Command="{Binding SaveCsvCommand}" />
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
